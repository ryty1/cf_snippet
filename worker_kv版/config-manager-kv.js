// Cloudflare Worker + KV ç‰ˆæœ¬é…ç½®ç®¡ç† - éœ€è¦ç»‘å®š KV å‘½åç©ºé—´: CONFIG_KV
// ç¯å¢ƒå˜é‡: PW(ç™»å½•å¯†ç ), AS(APIå¯†é’¥), VU(VLESSé¢æ¿åœ°å€), SU(SSé¢æ¿åœ°å€)
import { connect } from 'cloudflare:sockets';
const KV_KEY = 'config';
function getEnv(env) {
    const D = { PW: 'abc123456', AS: '24bb-49aa-9c37', VU: '', SU: '' };
    return { PW: env.PW || D.PW, AS: env.AS || D.AS, VU: env.VU || D.VU, SU: env.SU || D.SU };
}
export default { async fetch(request, env, ctx) { const E = getEnv(env); try { const url = new URL(request.url); const from = url.searchParams.get('from') || 'config'; if (request.method === 'GET') { if (url.pathname === '/') { return new Response(gHTML(from, E), { status: 200, headers: { 'Content-Type': 'text/html; charset=utf-8' } }); } if (url.pathname === '/api/config') return await gCfg(env); if (url.pathname === '/api/sync') return await gSync(request, env, E); if (url.pathname === '/api/share') return await gShare(request, env, E); if (url.pathname === '/api/socks') return await gSocks(request, env, E); if (url.pathname === '/api/check-socks') return await hCS(request, env); } if (request.method === 'POST' && url.pathname === '/api/config') return await sCfg(request, env); if (request.method === 'OPTIONS') return new Response(null, { headers: cors() }); return new Response('Not Found', { status: 404 }); } catch (err) { return new Response(err.toString(), { status: 500 }); } } };
async function gSocks(request, env, E) { try { const ua = request.headers.get('User-Agent'); if (ua !== 'VLESS-Worker') { return new Response(JSON.stringify({ error: 'Forbidden' }), { status: 403, headers: { 'Content-Type': 'application/json', ...cors() } }); } const url = new URL(request.url); const key = url.searchParams.get('key') || request.headers.get('X-API-Key'); if (key !== E.AS) { return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json', ...cors() } }); } const idx = parseInt(url.searchParams.get('index')); if (isNaN(idx) || idx < 0) { return new Response(JSON.stringify({ error: 'Invalid index' }), { status: 400, headers: { 'Content-Type': 'application/json', ...cors() } }); } const data = await env.CONFIG_KV.get(KV_KEY, { type: 'json' }); if (!data || !data.socks || idx >= data.socks.length) { return new Response(JSON.stringify({ error: 'SOCKS not found' }), { status: 404, headers: { 'Content-Type': 'application/json', ...cors() } }); } return new Response(JSON.stringify({ config: data.socks[idx].config, region: data.socks[idx].region, note: data.socks[idx].note }), { headers: { 'Content-Type': 'application/json', ...cors() } }); } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { 'Content-Type': 'application/json', ...cors() } }); } }
function cors() { return { 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Methods': 'GET, POST, OPTIONS', 'Access-Control-Allow-Headers': 'Content-Type' }; }
async function gCfg(env) { try { const data = await env.CONFIG_KV.get(KV_KEY, { type: 'json' }); const cfg = data || { socks: [], domains: [] }; return new Response(JSON.stringify(cfg), { headers: { 'Content-Type': 'application/json; charset=utf-8', ...cors() } }); } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { 'Content-Type': 'application/json', ...cors() } }); } }
async function gSync(request, env, E) { try { const url = new URL(request.url); const key = url.searchParams.get('key') || request.headers.get('X-API-Key'); if (key !== E.AS) { return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json', ...cors() } }); } const data = await env.CONFIG_KV.get(KV_KEY, { type: 'json' }); const cfg = data || { socks: [], domains: [] }; return new Response(JSON.stringify(cfg), { headers: { 'Content-Type': 'application/json; charset=utf-8', 'Cache-Control': 'no-store, max-age=0', ...cors() } }); } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { 'Content-Type': 'application/json', ...cors() } }); } }
async function gShare(request, env, E) { try { const url = new URL(request.url); const key = url.searchParams.get('key') || request.headers.get('X-API-Key'); if (key !== E.AS) { return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json', ...cors() } }); } const data = await env.CONFIG_KV.get(KV_KEY, { type: 'json' }); const cfg = data || { socks: [], domains: [] }; const masked = { socks: cfg.socks.map((s, i) => ({ region: s.region, config: `socks${i}`, note: s.note })), domains: cfg.domains }; return new Response(JSON.stringify(masked), { headers: { 'Content-Type': 'application/json; charset=utf-8', 'Cache-Control': 'no-store, max-age=0', ...cors() } }); } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { 'Content-Type': 'application/json', ...cors() } }); } }
async function sCfg(request, env) { try { const body = await request.json(); const { socks, domains } = body; const cfg = { socks: socks || [], domains: domains || [] }; await env.CONFIG_KV.put(KV_KEY, JSON.stringify(cfg)); return new Response(JSON.stringify({ success: true }), { headers: { 'Content-Type': 'application/json', ...cors() } }); } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { 'Content-Type': 'application/json', ...cors() } }); } }
function pS5(s) { if (!s) return null; s = s.trim(); let u = '', p = '', h, pt; const ai = s.lastIndexOf('@'); if (ai > 0) { const ap = s.substring(0, ai), hp = s.substring(ai + 1); const ci = ap.indexOf(':'); if (ci > 0) { u = ap.substring(0, ci); p = ap.substring(ci + 1); } const lc = hp.lastIndexOf(':'); if (lc > 0) { h = hp.substring(0, lc); pt = Number(hp.substring(lc + 1)); } else { h = hp; pt = 1080; } } else { const lc = s.lastIndexOf(':'); if (lc > 0) { h = s.substring(0, lc); pt = Number(s.substring(lc + 1)); } else { h = s; pt = 1080; } } if (isNaN(pt) || pt <= 0 || pt > 65535) return null; return { username: u, password: p, hostname: h, port: pt }; }
async function c2s5(pC, tH, tP) { const { username, password, hostname, port } = pC; const socket = connect({ hostname, port }); const writer = socket.writable.getWriter(); const reader = socket.readable.getReader(); try { const authMethods = username ? new Uint8Array([5, 2, 0, 2]) : new Uint8Array([5, 1, 0]); await writer.write(authMethods); const res1 = await reader.read(); if (res1.done || res1.value.byteLength < 2) throw new Error('æ¡æ‰‹å¤±è´¥'); const methodRes = new Uint8Array(res1.value); if (methodRes[0] !== 5 || methodRes[1] === 255) throw new Error('ä¸æ”¯æŒçš„è®¤è¯æ–¹å¼'); if (methodRes[1] === 2) { if (!username || !password) throw new Error('éœ€è¦è®¤è¯'); const enc = new TextEncoder(); const uBytes = enc.encode(username), pBytes = enc.encode(password); const authReq = new Uint8Array([1, uBytes.length, ...uBytes, pBytes.length, ...pBytes]); await writer.write(authReq); const res2 = await reader.read(); if (res2.done || new Uint8Array(res2.value)[1] !== 0) throw new Error('è®¤è¯å¤±è´¥'); } const hostBytes = new TextEncoder().encode(tH); const connReq = new Uint8Array([5, 1, 0, 3, hostBytes.length, ...hostBytes, tP >> 8, tP & 255]); await writer.write(connReq); const res3 = await reader.read(); if (res3.done || new Uint8Array(res3.value)[1] !== 0) throw new Error('è¿æ¥ç›®æ ‡å¤±è´¥'); writer.releaseLock(); reader.releaseLock(); return socket; } catch (e) { writer.releaseLock(); reader.releaseLock(); try { socket.close(); } catch (x) { } throw e; } }
async function hCS(request, env) { const url = new URL(request.url); const cfg = url.searchParams.get('config'); const idx = url.searchParams.get('index'); let socksConfig = cfg; if (idx !== null && !cfg) { const data = await env.CONFIG_KV.get(KV_KEY, { type: 'json' }); const i = parseInt(idx); if (data && data.socks && i >= 0 && i < data.socks.length) { socksConfig = data.socks[i].config; } } if (!socksConfig) { return new Response(JSON.stringify({ status: 'error', error: 'æ— æ•ˆé…ç½®' }), { headers: { 'Content-Type': 'application/json', ...cors() } }); } const startTime = Date.now(); try { const parsed = pS5(socksConfig); if (!parsed) { return new Response(JSON.stringify({ status: 'offline', error: 'é…ç½®æ ¼å¼é”™è¯¯', latency: -1 }), { headers: { 'Content-Type': 'application/json', ...cors() } }); } const timeoutPromise = new Promise((_, rej) => setTimeout(() => rej(new Error('è¿æ¥è¶…æ—¶')), 3000)); const connPromise = c2s5(parsed, '1.1.1.1', 80); const socket = await Promise.race([connPromise, timeoutPromise]); const latency = Date.now() - startTime; try { socket.close(); } catch (e) { } return new Response(JSON.stringify({ status: 'online', latency }), { headers: { 'Content-Type': 'application/json', ...cors() } }); } catch (e) { return new Response(JSON.stringify({ status: 'offline', error: e.message || 'è¿æ¥å¤±è´¥', latency: -1 }), { headers: { 'Content-Type': 'application/json', ...cors() } }); } }
function gHTML(from, E) { const backUrl = from === 'vless' ? E.VU + '/' : (from === 'ss' ? E.SU + '/' : ''); const backName = from === 'vless' ? 'VS' : (from === 'ss' ? 'SS' : ''); const chkUrl = from === 'vless' ? E.VU : (from === 'ss' ? E.SU : ''); const showBack = backUrl && backName; const np = !!(E.PW && E.PW.trim()); const shareUrl = '/api/share?key=' + E.AS; return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>é…ç½®ç®¡ç†</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--text:#e6edf3;--muted:#8b949e;--pri:#238636;--prih:#2ea043;--dan:#da3633;--danh:#f85149;--acc:#58a6ff}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:8px;display:flex;align-items:center;justify-content:center}.ct{max-width:1200px;margin:0 auto;width:100%;align-self:flex-start;padding-top:20px}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}h1{font-size:22px;background:linear-gradient(135deg,#58a6ff,#a371f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;gap:8px;text-decoration:none}.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--prih)}.btn-dan{background:var(--dan);color:#fff}.btn-dan:hover{background:var(--danh)}.btn-out{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-out:hover{border-color:var(--acc);color:var(--acc)}.btn-sm{padding:4px 10px;font-size:12px}.hd-act{display:flex;gap:8px;flex-wrap:wrap}.sec{background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:20px;overflow:hidden}.sec-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 10px;cursor:pointer;user-select:none;gap:6px}.sec-hd:hover{background:rgba(255,255,255,.03)}.sec-tt{font-size:clamp(12px,3.5vw,16px);font-weight:600;display:flex;align-items:center;gap:4px;white-space:nowrap;flex-shrink:0}.sec-tt::before{content:'';width:4px;height:18px;background:linear-gradient(180deg,#58a6ff,#a371f7);border-radius:2px;flex-shrink:0}.arrow{transition:transform .3s;font-size:12px;color:var(--muted)}.arrow.open{transform:rotate(90deg)}.sec-bd{max-height:0;overflow:hidden;transition:max-height .3s ease-out}.sec-bd.open{max-height:5000px}.sec-ct{padding:0 16px 16px}.cds{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}.cd{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;cursor:grab;transition:all .2s;position:relative}.cd:hover{border-color:var(--acc)}.cd.dg{opacity:.5}.cd.do{border-color:var(--pri);background:rgba(35,134,54,.1)}.cd.sel{border-color:var(--acc);background:rgba(88,166,255,.1)}.cd.online{border-color:var(--pri)}.cd.offline{border-color:var(--dan)}.cd-ck{position:absolute;top:50%;left:8px;transform:translateY(-50%);width:16px;height:16px;cursor:pointer}.cd.dm-cd{display:flex;align-items:center;padding:10px 8px}.dm-row{display:flex;align-items:center;gap:8px;width:100%}.dm-txt{font-size:13px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--acc)}.dm-cd .cd-ck{position:relative;top:0;left:0;transform:none;flex-shrink:0}.sk-hd{display:flex;justify-content:space-between;align-items:center;padding-left:24px;margin-bottom:6px;gap:4px}.sk-rg{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.sk-rg.on{color:var(--pri)}.sk-rg.off{color:var(--dan)}.sk-nt{font-size:11px;color:var(--muted);background:var(--card);padding:2px 6px;border-radius:3px;flex-shrink:0}.sk-row{display:flex;align-items:center;gap:8px;padding-left:24px}.sk-cfg{flex:1;font-size:12px;color:var(--muted);padding:6px;background:var(--card);border-radius:4px;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.sk-cfg:hover{background:rgba(88,166,255,.1)}.mdl{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}.mdl.act{display:flex}.mdl-ct{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;width:90%;max-width:450px;max-height:90vh;overflow-y:auto}.mdl-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.mdl-tt{font-size:16px;font-weight:600}.mdl-x{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1}.mdl-x:hover{color:var(--text)}.fg{margin-bottom:14px}.fl{display:block;margin-bottom:4px;font-size:13px;color:var(--muted)}.fi{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px}.fi:focus{outline:none;border-color:var(--acc)}.fm-act{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}.ld{text-align:center;padding:30px;color:var(--muted)}.tst{position:fixed;bottom:16px;right:16px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;z-index:1001;transform:translateY(100px);opacity:0;transition:all .3s}.tst.sh{transform:translateY(0);opacity:1}.tst.ok{border-color:var(--pri)}.tst.er{border-color:var(--dan)}.ety{text-align:center;padding:20px;color:var(--muted);font-size:13px}.cnt{font-size:12px;color:var(--muted);margin-left:8px}.file-input{display:none}.lo-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:30px;max-width:400px;width:100%;text-align:center}.lo-box h2{margin-bottom:20px;font-size:20px}.lo-box .fi{margin-bottom:12px;text-align:left}.lo-box .btn{width:100%;justify-content:center}.em{color:var(--dan);font-size:13px;padding:10px;background:rgba(218,54,51,.1);border-radius:6px;display:none;margin-bottom:12px}.dt-ct{font-size:13px;word-break:break-all;line-height:1.5;padding:12px;background:var(--bg);border-radius:6px;color:var(--acc);cursor:pointer}.dt-ct:hover{background:rgba(88,166,255,.1)}@media(max-width:600px){header{flex-direction:column;align-items:stretch}h1{text-align:center}.hd-act{flex-wrap:nowrap;justify-content:center;gap:8px}.hd-act .btn{flex:1;padding:8px 6px;font-size:12px}.cds{grid-template-columns:repeat(2,1fr);gap:8px}.sk-hd{padding-left:22px}.sk-row{padding-left:22px}.cd{padding:6px}.sk-rg{font-size:11px}.sk-nt{font-size:9px;padding:1px 4px}.sk-cfg{font-size:10px;padding:3px}.btn-sm{padding:2px 6px;font-size:10px}.sec-ct{padding:0 8px 12px}}</style></head><body><div class="lo-box" id="lo" style="display:${np ? 'block' : 'none'}"><h2>ğŸ” é…ç½®ç®¡ç†ç™»å½•</h2><form id="lf"><input type="password" class="fi" id="pw" placeholder="è¯·è¾“å…¥å¯†ç " required><div class="em" id="em">å¯†ç é”™è¯¯</div><button type="submit" class="btn btn-pri">ç™»å½•</button></form></div><div class="ct" id="mc" style="display:${np ? 'none' : 'block'}"><header><h1>ğŸ”§ KV é…ç½®ç®¡ç†</h1><div class="hd-act">${showBack ? `<a class="btn btn-out" href="${backUrl}">â¬… è¿”å› ${backName}</a>` : ''}<button class="btn btn-out" onclick="cpShare()">ğŸ”— åˆ†äº«é“¾æ¥</button><button class="btn btn-out" onclick="lC()">ğŸ”„ åˆ·æ–°</button><button class="btn btn-out" onclick="iF()">ğŸ“¥ å¯¼å…¥</button><button class="btn btn-pri" onclick="sC()">ğŸ’¾ ä¿å­˜</button><input type="file" id="fIn" class="file-input" accept=".json" onchange="hIF(event)"></div></header><div class="sec" id="ds"><div class="sec-hd" onclick="tgS('ds')"><h2 class="sec-tt">ä¼˜é€‰åŸŸå<span class="cnt" id="dc"></span></h2><div style="display:flex;align-items:center;gap:8px"><span id="dab"></span><button class="btn btn-pri btn-sm" onclick="event.stopPropagation();oDM()">+ æ–°å¢</button><span class="arrow" id="ds-ar">â–¶</span></div></div><div class="sec-bd" id="ds-bd"><div class="sec-ct"><div id="dl" class="cds"><div class="ld">åŠ è½½ä¸­...</div></div></div></div></div><div class="sec" id="ss"><div class="sec-hd" onclick="tgS('ss')"><h2 class="sec-tt">SOCKS ä»£ç†<span class="cnt" id="sc"></span></h2><div style="display:flex;align-items:center;gap:8px"><span id="sab"></span><button class="btn btn-pri btn-sm" onclick="event.stopPropagation();oSM()">+ æ–°å¢</button><span class="arrow" id="ss-ar">â–¶</span></div></div><div class="sec-bd" id="ss-bd"><div class="sec-ct"><div id="sl" class="cds"><div class="ld">åŠ è½½ä¸­...</div></div></div></div></div></div><div id="sm" class="mdl"><div class="mdl-ct"><div class="mdl-hd"><h3 class="mdl-tt" id="smt">æ–°å¢ SOCKS</h3><button class="mdl-x" onclick="cSM()">&times;</button></div><form id="sf" onsubmit="svS(event)"><input type="hidden" id="si" value="-1"><div class="fg"><label class="fl">åœ°åŒº *</label><input type="text" class="fi" id="sr" placeholder="ä¾‹å¦‚ï¼šæ–°åŠ å¡" required></div><div class="fg"><label class="fl">é…ç½® *</label><input type="text" class="fi" id="scc" placeholder="user:pass@host:port" required></div><div class="fg"><label class="fl">å¤‡æ³¨</label><input type="text" class="fi" id="sn" placeholder="ä¾‹å¦‚ï¼šVB"></div><div class="fm-act"><button type="button" class="btn btn-out" onclick="cSM()">å–æ¶ˆ</button><button type="submit" class="btn btn-pri">ä¿å­˜</button></div></form></div></div><div id="dm" class="mdl"><div class="mdl-ct"><div class="mdl-hd"><h3 class="mdl-tt" id="dmt">æ–°å¢åŸŸå</h3><button class="mdl-x" onclick="cDM()">&times;</button></div><form id="df" onsubmit="svD(event)"><input type="hidden" id="di" value="-1"><div class="fg"><label class="fl">åŸŸå *</label><input type="text" class="fi" id="dv" placeholder="ä¾‹å¦‚ï¼šcf.example.com" required></div><div class="fm-act"><button type="button" class="btn btn-out" onclick="cDM()">å–æ¶ˆ</button><button type="submit" class="btn btn-pri">ä¿å­˜</button></div></form></div></div><div id="dtm" class="mdl"><div class="mdl-ct"><div class="mdl-hd"><h3 class="mdl-tt">è¯¦æƒ…</h3><button class="mdl-x" onclick="cDT()">&times;</button></div><div class="dt-ct" id="dtc"></div></div></div><div id="tst" class="tst"></div><script>const PW='${E.PW}',np=${np},shareUrl='${shareUrl}';let cfg={socks:[],domains:[]},sSt={},sSel=new Set(),dSel=new Set(),skChkd=false;function cl(){return!np||sessionStorage.getItem('mng_l')==='1'}function sm(){document.getElementById('lo').style.display='none';document.getElementById('mc').style.display='block'}const lf=document.getElementById('lf');if(lf){lf.addEventListener('submit',e=>{e.preventDefault();if(document.getElementById('pw').value===PW){sessionStorage.setItem('mng_l','1');sm();lC();document.getElementById('em').style.display='none'}else{document.getElementById('em').style.display='block';document.getElementById('pw').value=''}})}function tgS(id){const bd=document.getElementById(id+'-bd'),ar=document.getElementById(id+'-ar'),isOpen=bd.classList.toggle('open');ar.classList.toggle('open',isOpen);if(id==='ss'&&isOpen&&!skChkd&&cfg.socks.length>0){skChkd=true;setTimeout(chkAll,300)}}async function lC(){try{tst('åŠ è½½ä¸­...','');const r=await fetch('/api/config');if(!r.ok)throw new Error('åŠ è½½å¤±è´¥');const d=await r.json();if(d.error)throw new Error(d.error);cfg={socks:d.socks||[],domains:d.domains||[]};sSt={};sSel.clear();dSel.clear();skChkd=false;rA();tst('åŠ è½½æˆåŠŸ','ok')}catch(e){tst('åŠ è½½å¤±è´¥: '+e.message,'er')}}async function sC(){try{tst('ä¿å­˜ä¸­...','');const r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({socks:cfg.socks,domains:cfg.domains})});const d=await r.json();if(d.error)throw new Error(d.error);tst('ä¿å­˜æˆåŠŸï¼','ok')}catch(e){tst('ä¿å­˜å¤±è´¥: '+e.message,'er')}}function iF(){document.getElementById('fIn').click()}function hIF(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.socks&&Array.isArray(d.socks))cfg.socks=[...cfg.socks,...d.socks];if(d.domains&&Array.isArray(d.domains))cfg.domains=[...cfg.domains,...d.domains];rA();tst('å¯¼å…¥æˆåŠŸ','ok')}catch(er){tst('å¯¼å…¥å¤±è´¥','er')}e.target.value=''};r.readAsText(f)}function rA(){rS();rD()}function msk(c){try{const ai=c.lastIndexOf('@');if(ai>0){const ap=c.substring(0,ai),ci=ap.indexOf(':');if(ci>0){return ap.substring(0,2)+'***:***@***:***'}return '***:***'}return '***:***'}catch(e){return '***:***'}}function mskD(d){try{const p=d.split('.');if(p.length>=2){return p[0]+'.****.'+p[p.length-1]}return '****'}catch(e){return '****'}}function tgSS(i){sSel.has(i)?sSel.delete(i):sSel.add(i);rS()}function tgDS(i){dSel.has(i)?dSel.delete(i):dSel.add(i);rD()}function saS(){cfg.socks.forEach((_,i)=>sSel.add(i));rS()}function caS(){sSel.clear();rS()}function dsS(){if(sSel.size===0)return;if(!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ '+sSel.size+' é¡¹å—ï¼Ÿ'))return;[...sSel].sort((a,b)=>b-a).forEach(i=>cfg.socks.splice(i,1));sSel.clear();rS();tst('å·²åˆ é™¤','ok')}function saD(){cfg.domains.forEach((_,i)=>dSel.add(i));rD()}function caD(){dSel.clear();rD()}function dsD(){if(dSel.size===0)return;if(!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ '+dSel.size+' é¡¹å—ï¼Ÿ'))return;[...dSel].sort((a,b)=>b-a).forEach(i=>cfg.domains.splice(i,1));dSel.clear();rD();tst('å·²åˆ é™¤','ok')}function rS(){const c=document.getElementById('sl'),b=document.getElementById('sab');document.getElementById('sc').textContent='('+cfg.socks.length+')';b.innerHTML=cfg.socks.length>0?'<span style="display:flex;gap:8px">'+'<button class="btn btn-out btn-sm" onclick="event.stopPropagation();saS()">å…¨é€‰</button>'+(sSel.size>0?'<button class="btn btn-out btn-sm" onclick="event.stopPropagation();caS()">å–æ¶ˆ</button><button class="btn btn-dan btn-sm" onclick="event.stopPropagation();dsS()">åˆ é™¤</button>':'')+'</span>':'';if(!cfg.socks||cfg.socks.length===0){c.innerHTML='<div class="ety">æš‚æ— é…ç½®</div>';return}c.innerHTML=cfg.socks.map((s,i)=>{const st=sSt[i],cls=st==='on'?'online':st==='off'?'offline':'',rgCls=st==='on'?'on':st==='off'?'off':'';return \`<div class="cd \${sSel.has(i)?'sel':''} \${cls}" draggable="true" data-t="socks" data-i="\${i}"><input type="checkbox" class="cd-ck" \${sSel.has(i)?'checked':''} onclick="event.stopPropagation();tgSS(\${i})"><div class="sk-hd"><span class="sk-rg \${rgCls}">\${esc(s.region)}</span>\${s.note?\`<span class="sk-nt">\${esc(s.note)}</span>\`:''}</div><div class="sk-row"><span class="sk-cfg" onclick="event.stopPropagation();sDT(\${i})">\${msk(s.config)}</span><button class="btn btn-out btn-sm" onclick="event.stopPropagation();eS(\${i})">ç¼–è¾‘</button></div></div>\`}).join('');aDE(c,'socks')}function rD(){const c=document.getElementById('dl'),b=document.getElementById('dab');document.getElementById('dc').textContent='('+cfg.domains.length+')';b.innerHTML=cfg.domains.length>0?'<span style="display:flex;gap:8px">'+'<button class="btn btn-out btn-sm" onclick="event.stopPropagation();saD()">å…¨é€‰</button>'+(dSel.size>0?'<button class="btn btn-out btn-sm" onclick="event.stopPropagation();caD()">å–æ¶ˆ</button><button class="btn btn-dan btn-sm" onclick="event.stopPropagation();dsD()">åˆ é™¤</button>':'')+'</span>':'';if(!cfg.domains||cfg.domains.length===0){c.innerHTML='<div class="ety">æš‚æ— é…ç½®</div>';return}c.innerHTML=cfg.domains.map((d,i)=>\`<div class="cd dm-cd \${dSel.has(i)?'sel':''}" draggable="true" data-t="domains" data-i="\${i}"><div class="dm-row"><input type="checkbox" class="cd-ck" \${dSel.has(i)?'checked':''} onclick="event.stopPropagation();tgDS(\${i})"><span class="dm-txt sk-cfg" onclick="event.stopPropagation();dDT(\${i})">\${mskD(d.domain)}</span><div><button class="btn btn-out btn-sm" onclick="event.stopPropagation();eD(\${i})">ç¼–è¾‘</button></div></div></div>\`).join('');aDE(c,'domains')}function aDE(ct,t){ct.querySelectorAll('.cd').forEach(cd=>{cd.addEventListener('dragstart',e=>{cd.classList.add('dg');e.dataTransfer.setData('text/plain',cd.dataset.i)});cd.addEventListener('dragend',()=>cd.classList.remove('dg'));cd.addEventListener('dragover',e=>{e.preventDefault();cd.classList.add('do')});cd.addEventListener('dragleave',()=>cd.classList.remove('do'));cd.addEventListener('drop',e=>{e.preventDefault();cd.classList.remove('do');const fi=parseInt(e.dataTransfer.getData('text/plain')),ti=parseInt(cd.dataset.i);if(fi!==ti){const a=cfg[t],[m]=a.splice(fi,1);a.splice(ti,0,m);t==='socks'?(sSel.clear(),rS()):(dSel.clear(),rD());tst('é¡ºåºå·²è°ƒæ•´','ok')}})})}function sDT(i){const s=cfg.socks[i],el=document.getElementById('dtc');el.textContent=s.config;el.onclick=()=>{navigator.clipboard.writeText('socks5://'+s.config).then(()=>tst('å·²å¤åˆ¶','ok'))};document.getElementById('dtm').classList.add('act')}function dDT(i){const d=cfg.domains[i],el=document.getElementById('dtc');el.textContent=d.domain;el.onclick=()=>{navigator.clipboard.writeText(d.domain).then(()=>tst('å·²å¤åˆ¶','ok'))};document.getElementById('dtm').classList.add('act')}function cDT(){document.getElementById('dtm').classList.remove('act')}async function chkAll(){tst('æ£€æµ‹ä¸­...','');for(let i=0;i<cfg.socks.length;i++){try{const r=await fetch('/api/check-socks?config='+encodeURIComponent(cfg.socks[i].config));const d=await r.json();sSt[i]=d.status==='online'?'on':'off'}catch(e){sSt[i]='off'}rS()}tst('æ£€æµ‹å®Œæˆ','ok')}function oSM(i=-1){document.getElementById('si').value=i;document.getElementById('smt').textContent=i===-1?'æ–°å¢ SOCKS':'ç¼–è¾‘ SOCKS';if(i>=0){const s=cfg.socks[i];document.getElementById('sr').value=s.region||'';document.getElementById('scc').value=s.config||'';document.getElementById('sn').value=s.note||''}else document.getElementById('sf').reset();document.getElementById('sm').classList.add('act')}function cSM(){document.getElementById('sm').classList.remove('act')}function svS(e){e.preventDefault();const i=parseInt(document.getElementById('si').value),it={region:document.getElementById('sr').value.trim(),config:document.getElementById('scc').value.trim(),note:document.getElementById('sn').value.trim()};if(i>=0)cfg.socks[i]=it;else cfg.socks.push(it);rS();cSM();tst(i>=0?'å·²æ›´æ–°':'å·²æ·»åŠ ','ok')}function eS(i){oSM(i)}function oDM(i=-1){document.getElementById('di').value=i;document.getElementById('dmt').textContent=i===-1?'æ–°å¢åŸŸå':'ç¼–è¾‘åŸŸå';if(i>=0)document.getElementById('dv').value=cfg.domains[i].domain||'';else document.getElementById('df').reset();document.getElementById('dm').classList.add('act')}function cDM(){document.getElementById('dm').classList.remove('act')}function svD(e){e.preventDefault();const i=parseInt(document.getElementById('di').value),it={domain:document.getElementById('dv').value.trim()};if(i>=0)cfg.domains[i]=it;else cfg.domains.push(it);rD();cDM();tst(i>=0?'å·²æ›´æ–°':'å·²æ·»åŠ ','ok')}function eD(i){oDM(i)}function esc(s){return s?s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):''}function cpShare(){const u=location.origin+shareUrl;navigator.clipboard.writeText(u).then(()=>tst('åˆ†äº«é“¾æ¥å·²å¤åˆ¶','ok')).catch(()=>tst('å¤åˆ¶å¤±è´¥','er'))}function tst(m,t=''){const e=document.getElementById('tst');e.textContent=m;e.className='tst sh '+(t==='ok'?'ok':t==='er'?'er':'');setTimeout(()=>e.classList.remove('sh'),3000)}window.onload=()=>{if(cl()){sm();lC()}};document.querySelectorAll('.mdl').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('act')}));</script></body></html>`; }

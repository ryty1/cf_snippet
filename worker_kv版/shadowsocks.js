import { connect } from 'cloudflare:sockets';
let sP = 'link', pI = 'ProxyIP.cmliussss.net';
let T = '5dc15e15-f285-4a9d-959b-0e4fbdd77b63', sSP = '';
const CU = '';                      // config-manager-kv.js çš„éƒ¨ç½²åœ°å€
const SU = '';                      // åˆ†äº«é“¾æ¥ï¼ˆå®Œæ•´ URL å«å¯†é’¥ï¼Œå¦‚ https://xxx/api/share?key=xxxï¼‰
const AS = '24bb-49aa-9c37';        // ä¸ config-manager-kv.js ä¸­çš„å¯†é’¥ä¿æŒä¸€è‡´
const SB = '';                      // clash è®¢é˜…åœ°å€
const PW = 'abc123456';             // å¯†ç 
function parseShareUrl(su) { if (!su) return { baseUrl: '', key: '' }; try { const u = new URL(su); const key = u.searchParams.get('key') || ''; u.pathname = ''; u.search = ''; return { baseUrl: u.origin, key }; } catch (e) { return { baseUrl: '', key: '' }; } }
const { baseUrl: SU_BASE, key: SU_KEY } = parseShareUrl(SU), CFG_URL = CU || SU_BASE, CFG_KEY = CU ? AS : SU_KEY, IS_OWNER = !!CU, CD = 0; let SC = [], DD = [{ domain: 'cf.090227.xyz' }], cC = null, cT = 0;
function genSocksKey(idx) { const src = T + '-socks-' + idx, chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789'; let hash = 0; for (let i = 0; i < src.length; i++) { hash = ((hash << 5) - hash) + src.charCodeAt(i); hash = hash & hash; } let key = ''; for (let i = 0; i < 8; i++) { hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff); key += chars[hash % chars.length]; } return key; }
async function lC() { if (!CFG_URL) return { socks: SC, domains: DD }; const now = Date.now(); if (cC && (now - cT) < CD) return cC; try { const apiPath = IS_OWNER ? '/api/sync' : '/api/sync-share'; const r = await fetch(`${CFG_URL}${apiPath}?key=${CFG_KEY}`, { headers: { 'User-Agent': 'VLESS-Worker' } }); if (!r.ok) throw new Error(`HTTP ${r.status}`); const data = await r.json(); if (data.socks && Array.isArray(data.socks)) SC = data.socks; if (data.domains && Array.isArray(data.domains)) DD = data.domains; cC = { socks: SC, domains: DD }; cT = now; } catch (e) { } return { socks: SC, domains: DD }; }
function cS(s) { try { if (s.readyState === 1 || s.readyState === 2) s.close(); } catch (e) { } }
function b64A(b) { if (!b) return { error: null }; try { const bs = atob(b.replace(/-/g, '+').replace(/_/g, '/')); const by = new Uint8Array(bs.length); for (let i = 0; i < bs.length; i++)by[i] = bs.charCodeAt(i); return { earlyData: by.buffer, error: null }; } catch (e) { return { error: e }; } }
function pPA(s) { if (!s) return null; s = s.trim(); if (s.startsWith('socks://') || s.startsWith('socks5://')) { try { const u = new URL(s.replace(/^socks/, 'socks5')); return { host: u.hostname, port: parseInt(u.port) || 1080, username: u.username ? decodeURIComponent(u.username) : '', password: u.password ? decodeURIComponent(u.password) : '' }; } catch (e) { return null; } } if (s.includes('@')) { const ai = s.lastIndexOf('@'), ap = s.substring(0, ai), hp = s.substring(ai + 1); let u = '', pw = ''; const ci = ap.indexOf(':'); if (ci > 0) { u = ap.substring(0, ci); pw = ap.substring(ci + 1); } let h = hp, p = 1080; if (hp.startsWith('[')) { const cb = hp.indexOf(']'); if (cb > 0) { h = hp.substring(1, cb); const r = hp.substring(cb + 1); if (r.startsWith(':')) { const pn = parseInt(r.substring(1), 10); if (!isNaN(pn) && pn > 0 && pn <= 65535) p = pn; } } } else { const lci = hp.lastIndexOf(':'); if (lci > 0) { h = hp.substring(0, lci); const pn = parseInt(hp.substring(lci + 1), 10); if (!isNaN(pn) && pn > 0 && pn <= 65535) p = pn; } } return { host: h, port: p, username: u, password: pw }; } if (s.startsWith('[')) { const cb = s.indexOf(']'); if (cb > 0) { const h = s.substring(1, cb), r = s.substring(cb + 1); if (r.startsWith(':')) { const p = parseInt(r.substring(1), 10); if (!isNaN(p) && p > 0 && p <= 65535) return { host: h, port: p, username: '', password: '' }; } return { host: h, port: 1080, username: '', password: '' }; } } const lci = s.lastIndexOf(':'); if (lci > 0) { const h = s.substring(0, lci), ps = s.substring(lci + 1), p = parseInt(ps, 10); if (!isNaN(p) && p > 0 && p <= 65535) return { host: h, port: p, username: '', password: '' }; } return { host: s, port: 1080, username: '', password: '' }; }
function iSTS(h) { const d = ['speedtest.net', 'fast.com', 'speedtest.cn', 'speed.cloudflare.com', 'ovo.speedtestcustom.com']; if (d.includes(h)) return true; for (const x of d) if (h.endsWith('.' + x) || h === x) return true; return false; }
async function hSS(request, cpi) { const url = new URL(request.url), sP = url.searchParams.get('socks'), sI = sP !== null ? parseInt(sP) : -1; let pSC = null, uSP = false; if (sI >= 0) { if (sI >= SC.length) return new Response('Unauthorized', { status: 401 }); const expKey = genSocksKey(sI), urlKeys = Array.from(url.searchParams.keys()); let hasKey = false; for (const k of urlKeys) { if (k === expKey && url.searchParams.get(k) === '') { hasKey = true; break; } } if (!hasKey) return new Response('Unauthorized', { status: 401 }); } if (SC.length > 0 && sI >= 0 && sI < SC.length) { const socksConfigStr = SC[sI].config; if (socksConfigStr) { pSC = pPA(socksConfigStr); if (pSC) uSP = true; } } const wssPair = new WebSocketPair(), [clientSock, serverSock] = Object.values(wssPair); serverSock.accept(); let rcw = { socket: null }; const earlyData = request.headers.get('sec-websocket-protocol') || '', readable = mRS(serverSock, earlyData); readable.pipeTo(new WritableStream({ async write(chunk) { if (rcw.socket) { const writer = rcw.socket.writable.getWriter(); await writer.write(chunk); writer.releaseLock(); return; } const { hasError, message, aT, port, hostname, rawIndex } = pSPH(chunk); if (hasError) throw new Error(message); if (iSTS(hostname)) throw new Error('Speedtest site is blocked'); const rawData = chunk.slice(rawIndex); await fT(hostname, port, rawData, serverSock, null, rcw, uSP ? pSC : cpi); }, })).catch((err) => { }); return new Response(null, { status: 101, webSocket: clientSock }); }
function pSPH(chunk) { if (chunk.byteLength < 7) return { hasError: true, message: 'Invalid data' }; try { const view = new Uint8Array(chunk), aT = view[0]; let addrIdx = 1, addrLen = 0, addrValIdx = addrIdx, hostname = ''; switch (aT) { case 1: addrLen = 4; hostname = new Uint8Array(chunk.slice(addrValIdx, addrValIdx + addrLen)).join('.'); addrValIdx += addrLen; break; case 3: addrLen = view[addrIdx]; addrValIdx += 1; hostname = new TextDecoder().decode(chunk.slice(addrValIdx, addrValIdx + addrLen)); addrValIdx += addrLen; break; case 4: addrLen = 16; const ipv6 = [], ipv6View = new DataView(chunk.slice(addrValIdx, addrValIdx + addrLen)); for (let i = 0; i < 8; i++) ipv6.push(ipv6View.getUint16(i * 2).toString(16)); hostname = ipv6.join(':'); addrValIdx += addrLen; break; default: return { hasError: true, message: `Invalid address type: ${aT}` }; } if (!hostname) return { hasError: true, message: `Invalid address: ${aT}` }; const port = new DataView(chunk.slice(addrValIdx, addrValIdx + 2)).getUint16(0); return { hasError: false, aT, port, hostname, rawIndex: addrValIdx + 2 }; } catch (e) { return { hasError: true, message: 'Failed to parse SS packet header' }; } }
async function c2s5(pC, tH, tP, iD) { const { host, port, username, password } = pC, connectHost = host.includes(':') && !host.startsWith('[') ? `[${host}]` : host, socket = connect({ hostname: connectHost, port: port }), writer = socket.writable.getWriter(), reader = socket.readable.getReader(); try { const authMethods = username && password ? new Uint8Array([0x05, 0x02, 0x00, 0x02]) : new Uint8Array([0x05, 0x01, 0x00]); await writer.write(authMethods); const methodResponse = await reader.read(); if (methodResponse.done || methodResponse.value.byteLength < 2) throw new Error('S5 method selection failed'); const selectedMethod = new Uint8Array(methodResponse.value)[1]; if (selectedMethod === 0x02) { if (!username || !password) throw new Error('S5 requires authentication'); const userBytes = new TextEncoder().encode(username), passBytes = new TextEncoder().encode(password), authPacket = new Uint8Array(3 + userBytes.length + passBytes.length); authPacket[0] = 0x01; authPacket[1] = userBytes.length; authPacket.set(userBytes, 2); authPacket[2 + userBytes.length] = passBytes.length; authPacket.set(passBytes, 3 + userBytes.length); await writer.write(authPacket); const authResponse = await reader.read(); if (authResponse.done || new Uint8Array(authResponse.value)[1] !== 0x00) throw new Error('S5 authentication failed'); } else if (selectedMethod !== 0x00) throw new Error(`S5 unsupported auth method: ${selectedMethod}`); const hostBytes = new TextEncoder().encode(tH), connectPacket = new Uint8Array(7 + hostBytes.length); connectPacket[0] = 0x05; connectPacket[1] = 0x01; connectPacket[2] = 0x00; connectPacket[3] = 0x03; connectPacket[4] = hostBytes.length; connectPacket.set(hostBytes, 5); new DataView(connectPacket.buffer).setUint16(5 + hostBytes.length, tP, false); await writer.write(connectPacket); const connectResponse = await reader.read(); if (connectResponse.done || new Uint8Array(connectResponse.value)[1] !== 0x00) throw new Error('S5 connection failed'); await writer.write(iD); writer.releaseLock(); reader.releaseLock(); return socket; } catch (error) { writer.releaseLock(); reader.releaseLock(); throw error; } }
async function fT(host, portNum, rawData, ws, respHeader, rcw, cpi) { async function cD(address, port, data) { const remoteSock = connect({ hostname: address, port: port }); await remoteSock.opened; const writer = remoteSock.writable.getWriter(); await writer.write(data); writer.releaseLock(); return remoteSock; } let pC = null, sUP = false; if (cpi) { if (typeof cpi === 'object' && cpi.host) { pC = cpi; sUP = true; } else if (typeof cpi === 'string') { pC = pPA(cpi); if (pC) sUP = true; } } if (!sUP) { try { const nS = await cD(pI, 443, rawData); rcw.socket = nS; nS.closed.catch(() => { }).finally(() => cS(ws)); cS2(nS, ws, respHeader, null); } catch (e) { cS(ws); } return; } let hasRetried = false; async function rC() { if (hasRetried) return; hasRetried = true; try { const newSocket = await c2s5(pC, pI, 443, rawData); rcw.socket = newSocket; newSocket.closed.catch(() => { }).finally(() => cS(ws)); cS2(newSocket, ws, respHeader, null); } catch (e) { cS(ws); } } try { const iS = await c2s5(pC, host, portNum, rawData); rcw.socket = iS; iS.closed.then(() => { if (ws.readyState === 1) rC(); }).catch(() => { rC(); }); cS2(iS, ws, respHeader, rC); } catch (e) { try { await rC(); } catch (err) { cS(ws); } } }
function mRS(socket, earlyDataHeader) { let cancelled = false; return new ReadableStream({ start(controller) { socket.addEventListener('message', (event) => { if (!cancelled) controller.enqueue(event.data); }); socket.addEventListener('close', () => { if (!cancelled) { cS(socket); controller.close(); } }); socket.addEventListener('error', (err) => controller.error(err)); const { earlyData, error } = b64A(earlyDataHeader); if (error) controller.error(error); else if (earlyData) controller.enqueue(earlyData); }, cancel() { cancelled = true; cS(socket); } }); }
async function cS2(rS, wS, hD, rF) { let header = hD, hasData = false; await rS.readable.pipeTo(new WritableStream({ async write(chunk, controller) { hasData = true; if (wS.readyState !== WebSocket.OPEN) controller.error('wsreadyState not open'); if (header) { const response = new Uint8Array(header.length + chunk.byteLength); response.set(header, 0); response.set(chunk, header.length); wS.send(response.buffer); header = null; } else { wS.send(chunk); } }, abort() { }, })).catch((err) => { cS(wS); }); if (!hasData && rF) { await rF(); } }
async function hCS(request) { if (!IS_OWNER) { return new Response(JSON.stringify({ error: 'åˆ†äº«æ¨¡å¼ä¸æ”¯æŒæ£€æµ‹', message: 'ä½¿ç”¨åˆ†äº«é…ç½®æ—¶ä¸æ”¯æŒSOCKSæœ‰æ•ˆæ€§æ£€æµ‹' }), { headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } }); } const url = new URL(request.url), idx = url.searchParams.get('index'), checkOne = async (socksConfig) => { const startTime = Date.now(); try { const parsed = pPA(socksConfig.config); if (!parsed) return { region: socksConfig.region, status: 'offline', latency: -1, error: 'æ— æ•ˆé…ç½®' }; const timeoutPromise = new Promise((_, reject) => { setTimeout(() => reject(new Error('è¿æ¥è¶…æ—¶')), 2000); }); const connectionPromise = c2s5(parsed, '1.1.1.1', 80, new Uint8Array(0)); const socket = await Promise.race([connectionPromise, timeoutPromise]); const latency = Date.now() - startTime; try { socket.close(); } catch (e) { } return { region: socksConfig.region, status: 'online', latency: latency }; } catch (error) { return { region: socksConfig.region, status: 'offline', latency: -1, error: error.message || 'Connection failed' }; } }; if (idx !== null) { const i = parseInt(idx); if (i >= 0 && i < SC.length) { const result = await checkOne(SC[i]); return new Response(JSON.stringify(result), { headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } }); } } const results = []; for (const socksConfig of SC) results.push(await checkOne(socksConfig)); return new Response(JSON.stringify({ results }), { headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } }); }
export default { async fetch(request, env) { await lC(); try { if (sP === 'link' || sP === '') sP = T; if (sSP === '') sSP = T; let vP = `/${sSP}`; const servers = pI.split(',').map(s => s.trim()); pI = servers[0]; const method = 'none', url = new URL(request.url), pathname = url.pathname; let pathProxyIP = null; if (pathname.startsWith('/proxyip=')) { try { pathProxyIP = decodeURIComponent(pathname.substring(9)).trim(); } catch (e) { } if (pathProxyIP && !request.headers.get('Upgrade')) { pI = pathProxyIP; return new Response(`set pI to: ${pI}\n\n`, { headers: { 'Content-Type': 'text/plain; charset=utf-8', 'Cache-Control': 'no-store, no-cache, must-revalidate, max-age=0' } }); } } if (request.headers.get('Upgrade') === 'websocket') { if (!pathname.toLowerCase().startsWith(vP.toLowerCase())) return new Response('Unauthorized', { status: 401 }); let wsPathProxyIP = null; if (pathname.startsWith('/proxyip=')) { try { wsPathProxyIP = decodeURIComponent(pathname.substring(9)).trim(); } catch (e) { } } const cpi = wsPathProxyIP || url.searchParams.get('proxyip') || request.headers.get('proxyip'); return await hSS(request, cpi); } else if (request.method === 'GET') { if (url.pathname === '/api/check-socks') return await hCS(request); if (url.pathname === '/') { const cd = url.hostname, np = !!(PW && PW.trim()), isOwner = IS_OWNER; const h = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SSè®¢é˜…</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--text:#e6edf3;--muted:#8b949e;--pri:#238636;--prih:#2ea043;--dan:#da3633;--danh:#f85149;--acc:#58a6ff}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:8px;display:flex;align-items:flex-start;justify-content:center;zoom:0.9}.co{max-width:1280px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:10px}#lo.co{max-width:400px;margin:auto}.h{background:var(--card);color:var(--text);padding:20px;text-align:center;position:relative;border-bottom:1px solid var(--border)}.h h2{font-size:22px;margin-bottom:8px;background:linear-gradient(135deg,#58a6ff,#a371f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.h p{font-size:13px;color:var(--muted)}.h .logout{position:absolute;top:20px;right:20px;color:var(--text);background:transparent;border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px}.h .logout:hover{border-color:var(--acc);color:var(--acc)}.s{padding:8px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg)}#ff{padding:16px;display:flex;flex-direction:column;gap:10px}.t{font-size:14px;font-weight:600;margin-bottom:0;color:var(--text);display:flex;align-items:center;cursor:pointer;user-select:none;gap:6px}.t::before{content:'';display:inline-block;width:4px;height:16px;background:linear-gradient(180deg,#58a6ff,#a371f7);margin-right:8px;border-radius:2px}.t .arrow{transition:transform .3s;display:inline-block;color:var(--muted);font-size:12px}.t .arrow.open{transform:rotate(90deg)}.t .btn-small:first-of-type{margin-left:auto}.fold-content{max-height:0;overflow:hidden;transition:max-height .3s ease-out}.fold-content.open{max-height:2000px}.btn-group{display:flex;gap:6px}.btn-small{padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);font-size:11px;cursor:pointer}.btn-small:hover{border-color:var(--acc);color:var(--acc)}.dg{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:8px}.di{display:flex;align-items:center;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);font-size:12px;cursor:pointer;overflow:hidden}.di:hover{border-color:var(--acc)}.di.sel{border-color:var(--acc);background:rgba(88,166,255,.1)}.di input{margin-right:8px;cursor:pointer;flex-shrink:0}.di span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--acc)}#sc{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}.c{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;min-width:0}.c.on{border-color:var(--pri);background:rgba(35,134,54,.1)}.c.off{border-color:var(--dan);background:rgba(218,54,51,.1)}.c div{display:flex;justify-content:space-between;gap:4px;margin:3px 0}.c b{font-size:13px;flex-shrink:0;color:var(--text)}.c span{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.c .chk-btn{padding:4px 10px;font-size:11px;background:var(--border);color:var(--text);border:none;border-radius:4px;cursor:pointer;flex-shrink:0}.c .chk-btn:hover{background:var(--muted)}.c.on .chk-btn{background:var(--pri);color:#fff}.c.on .chk-btn:hover{background:var(--prih)}.c.off .chk-btn{background:var(--dan);color:#fff}.c.off .chk-btn:hover{background:var(--danh)}.c .row2{display:flex;align-items:center;justify-content:space-between;gap:4px}.c .left{display:flex;align-items:center;gap:4px;margin:0}.c .ip-row{display:flex;justify-content:space-between;align-items:center;gap:4px}.c .latency{display:inline}.c .m-name{display:none}@media(max-width:767px){#sc{grid-template-columns:repeat(2,1fr)}.c{padding:6px}.c .ip-row{display:none}.c .row2{justify-content:space-between;gap:6px}.c .latency{display:none}.c b{font-size:12px}.c .m-name{display:block;font-size:12px;font-weight:600;color:var(--text);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}.c .left{flex:1;min-width:0;display:flex;align-items:center;gap:4px}.c .left span:first-child{flex-shrink:0}.s{padding:12px 8px}#ff{padding:10px 8px}}@media(min-width:768px){.dg{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}#sc{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}.c .m-name{display:none}}.gen{width:100%;padding:12px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer}.gen:hover{background:var(--prih)}.res{margin-top:12px;padding:12px;background:var(--bg);border-radius:6px;border:1px solid var(--border);display:none}.res .app-label{display:inline-block;background:var(--dan);color:#fff;padding:4px 12px;border-radius:4px;font-weight:600;font-size:12px;margin-right:10px;vertical-align:middle;width:70px;text-align:center;flex-shrink:0}.res .link-wrapper{display:flex;align-items:center}.res input{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:11px;background:var(--bg);cursor:pointer;text-align:left;color:var(--acc);font-weight:500}.lo{padding:24px}.lf{display:flex;flex-direction:column;gap:16px}.ig{display:flex;flex-direction:column;gap:6px}.ig label{font-size:13px;font-weight:500;color:var(--muted)}.ig input{padding:10px;border:1px solid var(--border);border-radius:6px;font-size:14px;background:var(--bg);color:var(--text)}.ig input:focus{outline:none;border-color:var(--acc)}.lb{padding:12px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer}.lb:hover{background:var(--prih)}.em{color:var(--dan);font-size:13px;padding:10px;background:rgba(218,54,51,.1);border-radius:6px;display:none}</style></head><body><div class="co" id="lo" style="display:${np ? 'block' : 'none'}"><div class="h"><h2>ğŸ” ç™»å½•</h2></div><div class="lo"><form class="lf" id="lf"><div class="ig"><label>å¯†ç </label><input type="password" id="pw" required></div><div class="em" id="em">å¯†ç é”™è¯¯</div><button type="submit" class="lb">ç™»å½•</button></form></div></div><div class="co" id="mc" style="display:${np ? 'none' : 'block'}"><div class="h"><button class="logout" onclick="logout()">é€€å‡º</button>${isOwner && CU ? '<button class="logout" style="left:20px;right:auto" onclick="goCfg()">é…ç½®</button>' : ''}<h2>ğŸš€ ShadowSocks</h2><p>é€‰æ‹©åŸŸåç”Ÿæˆä¸“å±è®¢é˜…é“¾æ¥(é»˜è®¤443ç«¯å£)ï¼ŒClashè®¢é˜…æ‹¼æ¥ä¸ºè€ç‹å¤§ä½¬çš„åç«¯</p></div><form id="ff"><div class="s"><div class="t" onclick="tgF('dm')">ğŸ”­ ä¼˜é€‰åŸŸå<span class="arrow" id="dm-arrow">â–¶</span> (${DD.length})<button type="button" class="btn-small" onclick="event.stopPropagation();sA()">å…¨é€‰</button><button type="button" class="btn-small" onclick="event.stopPropagation();cA()">æ¸…ç©º</button></div><div class="fold-content" id="dm-fold"><div class="dg" id="dg"></div></div></div><div class="s"><div class="t" onclick="tgF('sk')">ğŸ“¡ SOCKSçŠ¶æ€<span class="arrow" id="sk-arrow">â–¶</span> (${SC.length})${isOwner ? '<button type="button" class="btn-small" onclick="event.stopPropagation();chkS()">åˆ·æ–°å…¨éƒ¨</button>' : ''}</div><div class="fold-content" id="sk-fold"><div id="sc">${SC.map((s, i) => isOwner ? `<div class="c" data-i="${i}"><div class="ip-row"><b>${s.region}</b><span id="ip${i}">-</span></div><div class=\"row2\"><div class=\"left\"><span id=\"s${i}\">âšª</span><span class=\"latency\" id=\"l${i}\">-</span><b class=\"m-name\">${s.region}</b></div><button type=\"button\" class=\"chk-btn\" onclick=\"event.stopPropagation();chkOne(${i})\">é‡æµ‹</button></div></div>` : `<div class="c" data-i="${i}" style="padding:8px;display:flex;justify-content:space-between;align-items:center"><b>${s.region}</b><span style="color:var(--muted)">${s.note || ''}</span></div>`).join('')}</div></div></div><button type="submit" class="gen">âœ¨ ç”Ÿæˆè®¢é˜…</button></form><div id="res" class="res"><div class="link-wrapper"><span class="app-label">V2rayN</span><input type="text" id="url" readonly onclick="cpU()" title="ç‚¹å‡»å¤åˆ¶"></div></div><div id="cres" class="res" style="margin-top:10px"><div class="link-wrapper"><span class="app-label">Clash</span><input type="text" id="curl" readonly onclick="cpC()" title="ç‚¹å‡»å¤åˆ¶"></div></div></div><script>const PW='${PW}',np=${np},isOwner=${isOwner},ds=[${DD.map(d => `{n:"${d.name || d.domain}",d:"${d.domain}"}`).join(',')}],SC=[${SC.map(s => `{region:"${s.region}",config:"${isOwner ? s.config : '***'}"}`).join(',')}];let skChkd=false;function tgF(id){const f=document.getElementById(id+'-fold'),a=document.getElementById(id+'-arrow');const isOpen=f.classList.toggle('open');a.classList.toggle('open',isOpen);if(id==='sk'&&isOpen&&!skChkd&&isOwner){skChkd=true;setTimeout(chkS,300)}}function cl(){return!np||sessionStorage.getItem('ss_l')==='1'}function sm(){document.getElementById('lo').style.display='none';document.getElementById('mc').style.display='block'}const lf=document.getElementById('lf');if(lf){lf.addEventListener('submit',e=>{e.preventDefault();if(document.getElementById('pw').value===PW){sessionStorage.setItem('ss_l','1');sm();init();document.getElementById('em').style.display='none'}else{document.getElementById('em').style.display='block';document.getElementById('pw').value=''}})}function mIP(ip){if(!ip||ip==='-')return ip;if(ip.includes(':')){const p=ip.replace(/^\\\\[|\\\\]$/g,'').split(':');if(p.length>=4)return'['+p[0]+':'+p[1]+':***:'+p[p.length-1]+']';return ip}const p=ip.split('.');if(p.length===4)return p[0]+'.***.***.'+p[3];return ip}function pIP(c){try{const a=c.lastIndexOf('@');let h;if(a===-1){h=c}else{h=c.substring(a+1)}const ci=h.lastIndexOf(':');const ip=ci===-1?h:h.substring(0,ci);return mIP(ip)}catch(e){return'å¤±è´¥'}}function init(){const g=document.getElementById('dg');g.innerHTML='';ds.forEach((d,i)=>{const di=document.createElement('div');di.className='di';di.innerHTML=\`<input type="checkbox" name="d" value="\${i}" onchange="uS(this)"><span>\${d.n}</span>\`;di.onclick=e=>{if(e.target.type!=='checkbox'){const cb=di.querySelector('input');cb.checked=!cb.checked;uS(cb)}};g.appendChild(di)});const cs=document.querySelectorAll('.c');cs.forEach(c=>{const ix=c.dataset.i;const cfg=SC[ix]?.config;if(cfg)document.getElementById('ip'+ix).textContent=pIP(cfg)})}function uS(cb){cb.closest('.di').classList.toggle('sel',cb.checked)}function sA(){const f=document.getElementById('dm-fold'),a=document.getElementById('dm-arrow');if(!f.classList.contains('open')){f.classList.add('open');a.classList.add('open')}document.querySelectorAll('[name=\"d\"]').forEach(cb=>{cb.checked=true;uS(cb)})}function cA(){document.querySelectorAll('[name=\"d\"]').forEach(cb=>{cb.checked=false;uS(cb)})}document.getElementById('ff').onsubmit=function(e){e.preventDefault();const sd=Array.from(document.querySelectorAll('input[name="d"]:checked')).map(cb=>cb.value);const qs=sd.length>0?'?domains='+sd.join(','):'';const u=window.location.origin+'/sub/'+'${sP}'.split('-')[0]+qs;const cu=u+(u.includes('?')?'&':'?')+'clash';document.getElementById('url').value=u;document.getElementById('curl').value=cu;document.getElementById('res').style.display='block';document.getElementById('cres').style.display='block';document.getElementById('url').scrollIntoView({behavior:'smooth',block:'center'})};function cpU(){const i=document.getElementById('url');if(i.value.includes('âœ…'))return;const v=i.value;i.select();document.execCommand('copy');i.value='âœ… å·²å¤åˆ¶æˆåŠŸ!';const oc=i.style.color;i.style.color='#4CAF50';setTimeout(()=>{i.value=v;i.style.color=oc},1500)}function cpC(){const i=document.getElementById('curl');if(i.value.includes('âœ…'))return;const v=i.value;i.select();document.execCommand('copy');i.value='âœ… å·²å¤åˆ¶æˆåŠŸ!';const oc=i.style.color;i.style.color='#4CAF50';setTimeout(()=>{i.value=v;i.style.color=oc},1500)}function logout(){sessionStorage.removeItem('ss_l');location.reload()}function goCfg(){window.location.href='${CU}/?from=ss'}async function chkOne(ix){if(!isOwner)return;const c=document.querySelectorAll('.c')[ix];c.classList.remove('on','off');document.getElementById('s'+ix).textContent='â³';try{const r=await fetch('/api/check-socks?index='+ix),d=await r.json();if(d.status==='online'){document.getElementById('s'+ix).textContent='ğŸŸ¢';document.getElementById('l'+ix).textContent=d.latency+'ms';c.classList.add('on')}else{document.getElementById('s'+ix).textContent='ğŸ”´';document.getElementById('l'+ix).textContent='ç¦»çº¿';c.classList.add('off')}}catch(e){document.getElementById('s'+ix).textContent='ğŸ”´';document.getElementById('l'+ix).textContent='é”™è¯¯';c.classList.add('off')}}async function chkS(){if(!isOwner)return;const cs=document.querySelectorAll('.c');cs.forEach(c=>{c.classList.remove('on','off')});for(let i=0;i<cs.length;i++){await chkOne(i)}}window.onload=()=>{if(cl()){sm();init()}else if(np){document.getElementById('lo').style.display='block'}else{init()}}</script></body></html>`; return new Response(h, { status: 200, headers: { 'Content-Type': 'text/html;charset=utf-8', 'Cache-Control': 'no-cache' } }); } if (url.pathname.toLowerCase().startsWith(`/sub/${sP.split('-')[0].toLowerCase()}`)) { const isClash = url.searchParams.has('clash'); if (isClash) { const subUrl = new URL(request.url); subUrl.searchParams.delete('clash'); const cvUrl = SB ? `${SB}/sub?url=${encodeURIComponent(subUrl.toString())}&target=clash.meta&emoji=true` : `https://sub.ssss.xx.kg/clash?config=${encodeURIComponent(subUrl.toString())}&ua=&selectedRules="comprehensive"&customRules=[]`; try { const r = await fetch(cvUrl, { headers: { 'User-Agent': 'ClashMeta' } }); const txt = await r.text(); return new Response(txt, { headers: { 'Content-Type': 'text/yaml; charset=utf-8', 'Cache-Control': 'no-store' } }); } catch (e) { return new Response('Clash convert failed', { status: 500 }); } } const cd = url.hostname, sh = 's' + 's', sl = []; const domainParam = url.searchParams.get('domains'), portParam = url.searchParams.get('ports'); let sPts = portParam ? portParam.split(',').map(p => parseInt(p)) : [443]; let dTU = DD; if (domainParam) { const idxs = domainParam.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 0 && n < DD.length); if (idxs.length > 0) dTU = idxs.map(i => DD[i]); } dTU.forEach(d => { if (SC.length === 0) { sPts.forEach(p => { const dn = `Snip-é»˜è®¤`, dc = btoa(`${method}:${T}`), dwp = `${vP}/?ed=2560`; sl.push(`${sh}://${dc}@${d.domain}:${p}?plugin=v2ray-plugin;mode%3Dwebsocket;host%3D${cd};path%3D${encodeURIComponent(dwp)};${p === 443 ? 'tls;sni%3D' + cd + ';' : ''}skip-cert-verify%3Dtrue;mux%3D0#${encodeURIComponent(dn)}`) }); } SC.forEach((s, i) => { sPts.forEach(p => { const n = `Snip-${s.region}-${s.note || ''}-SS`, c = btoa(`${method}:${T}`), wp = `${vP}/?ed=2560&socks=${i}&${genSocksKey(i)}`; sl.push(`${sh}://${c}@${d.domain}:${p}?plugin=v2ray-plugin;mode%3Dwebsocket;host%3D${cd};path%3D${encodeURIComponent(wp)};${p === 443 ? 'tls;sni%3D' + cd + ';' : ''}skip-cert-verify%3Dtrue;mux%3D0#${encodeURIComponent(n)}`) }) }) }); return new Response(btoa(unescape(encodeURIComponent(sl.join('\n')))), { headers: { 'Content-Type': 'text/plain; charset=utf-8', 'Cache-Control': 'no-store' } }); } } return new Response('Not Found', { status: 404 }); } catch (err) { return new Response('Internal Server Error', { status: 500 }); } } };

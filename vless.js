import { connect } from 'cloudflare:sockets';
const T = '4bc511be-7d08-4487-966b-12f40fd5014a';
const FA = 'ProxyIP.cmliussss.net';
const FP = '443';
const PW = 'abc123456';
const MNG_URL = '';
const CU = '';
const GT = '';
let SC = [];
let DD = [{ domain: 'cf.090227.xyz' }, { domain: 'cf.877774.xyz' }];
let cC = null;
let cT = 0;
const CD = 5 * 60 * 1000;
const E1 = atob('aW52YWxpZCBkYXRh'), E2 = atob('aW52YWxpZCB1c2Vy'), E3 = atob('Y29tbWFuZCBpcyBub3Qgc3VwcG9ydGVk'), E4 = atob('VURQIHByb3h5IG9ubHkgZW5hYmxlIGZvciBETlMgd2hpY2ggaXMgcG9ydCA1Mw=='), E5 = atob('aW52YWxpZCBhZGRyZXNzVHlwZQ=='), E6 = atob('YWRkcmVzc1ZhbHVlIGlzIGVtcHR5'), E7 = atob('d2ViU29ja2V0LmVhZHlTdGF0ZSBpcyBub3Qgb3Blbg=='), E8 = atob('U3RyaW5naWZpZWQgaWRlbnRpZmllciBpcyBpbnZhbGlk'), E9 = atob('SW52YWxpZCBTT0NLUyBhZGRyZXNzIGZvcm1hdA=='), EA = atob('bm8gYWNjZXB0YWJsZSBtZXRob2Rz'), EB = atob('c29ja3Mgc2VydmVyIG5lZWRzIGF1dGg='), EC = atob('ZmFpbCB0byBhdXRoIHNvY2tzIHNlcnZlcg=='), ED = atob('ZmFpbCB0byBvcGVuIHNvY2tzIGNvbm5lY3Rpb24=');
const A1 = 1, A2 = 2, A3 = 3;
function iCFS(h) { const d = ['cloudflare.com', 'cloudflare.net', 'cloudflare-dns.com', 'one.one.one.one', 'warp.plus', 'cloudflarewarp.com']; for (const x of d) if (h === x || h.endsWith('.' + x)) return true; return false; }
async function lC() { const now = Date.now(); if (cC && (now - cT) < CD) return cC; try { const h = { 'User-Agent': 'Cloudflare-Worker' }; if (GT) h.Authorization = `token ${GT}`; const r = await fetch(CU, { headers: h, cf: { cacheTtl: 300, cacheEverything: true } }); if (!r.ok) throw new Error(`HTTP ${r.status}`); const c = await r.json(); if (c.socks && Array.isArray(c.socks)) SC = c.socks; if (c.domains && Array.isArray(c.domains)) DD = c.domains; cC = { socks: SC, domains: DD }; cT = now; } catch (e) { } return { socks: SC, domains: DD }; }
export default { async fetch(request, env, ctx) { await lC(); try { const url = new URL(request.url); if (request.headers.get('Upgrade') === 'websocket') return await hWs(request); else if (request.method === 'GET') { if (url.pathname === '/') return new Response(gHTML(), { status: 200, headers: { 'Content-Type': 'text/html; charset=utf-8' } }); if (url.pathname === '/api/check-socks') return await hChk(request); if (url.pathname.toLowerCase().includes(`/${T}`)) return await hSub(request, T); } return new Response('Not Found', { status: 404 }); } catch (err) { return new Response(err.toString(), { status: 500 }); } } };
async function hSub(request, uuid) { const url = new URL(request.url), fL = [], wd = url.hostname, ft = { domains: url.searchParams.get('domains')?.split(',') || [], ports: url.searchParams.get('ports')?.split(',') || [] }; const dl = ft.domains.length > 0 ? DD.filter(d => ft.domains.some(sel => d.domain.toLowerCase().includes(sel.toLowerCase()))) : DD; fL.push(...gLinks(dl, uuid, wd, ft)); if (fL.length === 0) return new Response('No nodes available', { status: 404 }); const st = fL.join('\n'), enc = new TextEncoder(), ub = enc.encode(st), sc = btoa(String.fromCharCode(...ub)); return new Response(sc, { headers: { 'Content-Type': 'text/plain; charset=utf-8', 'Cache-Control': 'no-store, no-cache, must-revalidate, max-age=0' } }); }
function gLinks(dl, uuid, wd, ft = {}) { const p = 443, links = [], wp = encodeURIComponent('/?ed=2048'), proto = 'vless'; dl.forEach(item => { if (SC.length > 0) { const dn = `Snip-æ–°åŠ å¡-ç›´è¿`, dp = new URLSearchParams({ encryption: 'none', security: 'tls', type: 'ws', host: wd, path: wp }); dp.append('sni', wd); dp.append('fp', 'firefox'); links.push(`${proto}://${uuid}@${item.domain}:${p}?${dp.toString()}#${encodeURIComponent(dn)}`); SC.forEach((sc, si) => { const { region, note } = sc, nn = `Snip-${region}-${note || ''}`, wps = encodeURIComponent(`/?ed=2048&socks=${si}`), pm = new URLSearchParams({ encryption: 'none', security: 'tls', type: 'ws', host: wd, path: wps }); pm.append('sni', wd); pm.append('fp', 'firefox'); links.push(`${proto}://${uuid}@${item.domain}:${p}?${pm.toString()}#${encodeURIComponent(nn)}`); }); } else { const nn = `Sinppets-${item.domain}`, pm = new URLSearchParams({ encryption: 'none', security: 'tls', type: 'ws', host: wd, path: wp }); pm.append('sni', wd); pm.append('fp', 'firefox'); links.push(`${proto}://${uuid}@${item.domain}:${p}?${pm.toString()}#${encodeURIComponent(nn)}`); } }); return links; }
async function hWs(request) { const url = new URL(request.url), sP = url.searchParams.get('socks'), sI = sP !== null ? parseInt(sP) : -1; let pSC = {}, iSE = false; if (SC.length > 0 && sI >= 0 && sI < SC.length) { try { pSC = pS5(SC[sI].config); iSE = true; } catch (e) { } } const wsPair = new WebSocketPair(), [cS, sS] = Object.values(wsPair); sS.accept(); let rcw = { socket: null }, isDns = false; const ed = request.headers.get('sec-websocket-protocol') || '', rd = mRS(sS, ed); rd.pipeTo(new WritableStream({ async write(chunk) { if (isDns) return await fUDP(chunk, sS, null); if (rcw.socket) { const w = rcw.socket.writable.getWriter(); await w.write(chunk); w.releaseLock(); return; } const { hasError, message, addressType, port, hostname, rawIndex, version, isUDP } = pPkt(chunk, T); if (hasError) throw new Error(message); if (isUDP) { if (port === 53) isDns = true; else throw new Error(E4); } const rh = new Uint8Array([version[0], 0]), rD = chunk.slice(rawIndex); if (isDns) return fUDP(rD, sS, rh); await fTCP(addressType, hostname, port, rD, sS, rh, rcw, iSE, pSC); } })).catch((e) => { }); return new Response(null, { status: 101, webSocket: cS }); }
async function fTCP(aT, host, pN, rD, ws, rh, rcw, iSE, pSC) { const fCF = iCFS(host); async function cAS(addr, port) { const rS = iSE ? await eSocks(aT, addr, port, pSC) : connect({ hostname: addr, port: port }), w = rS.writable.getWriter(); await w.write(rD); w.releaseLock(); return rS; } async function rC() { const nS = iSE ? await cAS(host, pN) : await cAS(FA || host, parseInt(FP, 10) || pN); rcw.socket = nS; nS.closed.catch(() => { }).finally(() => cSock(ws)); cStr(nS, ws, rh, null); } if (fCF && !iSE) { try { await rC(); } catch (err) { cSock(ws); } return; } try { const iS = await cAS(host, pN); rcw.socket = iS; cStr(iS, ws, rh, rC); } catch (e) { try { await rC(); } catch (err) { cSock(ws); } } }
function pPkt(chunk, token) { if (chunk.byteLength < 24) return { hasError: true, message: E1 }; const ver = new Uint8Array(chunk.slice(0, 1)); if (fID(new Uint8Array(chunk.slice(1, 17))) !== token) return { hasError: true, message: E2 }; const oL = new Uint8Array(chunk.slice(17, 18))[0], cmd = new Uint8Array(chunk.slice(18 + oL, 19 + oL))[0]; let isUDP = false; if (cmd === 1) { } else if (cmd === 2) { isUDP = true; } else return { hasError: true, message: E3 }; const pI = 19 + oL, port = new DataView(chunk.slice(pI, pI + 2)).getUint16(0); let aI = pI + 2, aL = 0, aVI = aI + 1, hn = ''; const aT = new Uint8Array(chunk.slice(aI, aVI))[0]; switch (aT) { case A1: aL = 4; hn = new Uint8Array(chunk.slice(aVI, aVI + aL)).join('.'); break; case A2: aL = new Uint8Array(chunk.slice(aVI, aVI + 1))[0]; aVI += 1; hn = new TextDecoder().decode(chunk.slice(aVI, aVI + aL)); break; case A3: aL = 16; const ipv6 = [], iv = new DataView(chunk.slice(aVI, aVI + aL)); for (let i = 0; i < 8; i++) ipv6.push(iv.getUint16(i * 2).toString(16)); hn = ipv6.join(':'); break; default: return { hasError: true, message: `${E5}: ${aT}` }; } if (!hn) return { hasError: true, message: `${E6}: ${aT}` }; return { hasError: false, addressType: aT, port, hostname: hn, isUDP, rawIndex: aVI + aL, version: ver }; }
function mRS(socket, edH) { let c = false; return new ReadableStream({ start(ctrl) { socket.addEventListener('message', (e) => { if (!c) ctrl.enqueue(e.data); }); socket.addEventListener('close', () => { if (!c) { cSock(socket); ctrl.close(); } }); socket.addEventListener('error', (e) => ctrl.error(e)); const { earlyData, error } = b64A(edH); if (error) ctrl.error(error); else if (earlyData) ctrl.enqueue(earlyData); }, cancel() { c = true; cSock(socket); } }); }
async function cStr(rS, wS, hD, rF) { let h = hD, hsDt = false; await rS.readable.pipeTo(new WritableStream({ async write(chunk, ctrl) { hsDt = true; if (wS.readyState !== 1) ctrl.error(E7); if (h) { wS.send(await new Blob([h, chunk]).arrayBuffer()); h = null; } else wS.send(chunk); }, abort(r) { } })).catch((e) => { cSock(wS); }); if (!hsDt && rF) rF(); }
async function fUDP(uC, wS, rH) { try { const tS = connect({ hostname: '8.8.4.4', port: 53 }); let vH = rH; const w = tS.writable.getWriter(); await w.write(uC); w.releaseLock(); await tS.readable.pipeTo(new WritableStream({ async write(chunk) { if (wS.readyState === 1) { if (vH) { wS.send(await new Blob([vH, chunk]).arrayBuffer()); vH = null; } else wS.send(chunk); } } })); } catch (e) { } }
async function eSocks(aT, addr, port, pSC) { const { username, password, hostname, socksPort } = pSC, s = connect({ hostname, port: socksPort }), w = s.writable.getWriter(); await w.write(new Uint8Array(username ? [5, 2, 0, 2] : [5, 1, 0])); const r = s.readable.getReader(); let res = (await r.read()).value; if (res[0] !== 5 || res[1] === 255) throw new Error(EA); if (res[1] === 2) { if (!username || !password) throw new Error(EB); const enc = new TextEncoder(), aR = new Uint8Array([1, username.length, ...enc.encode(username), password.length, ...enc.encode(password)]); await w.write(aR); res = (await r.read()).value; if (res[0] !== 1 || res[1] !== 0) throw new Error(EC); } const enc = new TextEncoder(); let DA; switch (aT) { case A1: DA = new Uint8Array([1, ...addr.split('.').map(Number)]); break; case A2: DA = new Uint8Array([3, addr.length, ...enc.encode(addr)]); break; case A3: DA = new Uint8Array([4, ...addr.split(':').flatMap(x => [parseInt(x.slice(0, 2), 16), parseInt(x.slice(2), 16)])]); break; default: throw new Error(E5); } await w.write(new Uint8Array([5, 1, 0, ...DA, port >> 8, port & 255])); res = (await r.read()).value; if (res[1] !== 0) throw new Error(ED); w.releaseLock(); r.releaseLock(); return s; }
function pS5(s) { let u, p, h, pt; const ai = s.lastIndexOf('@'); if (ai > 0) { const ap = s.substring(0, ai), hp = s.substring(ai + 1), ci = ap.indexOf(':'); if (ci > 0) { u = ap.substring(0, ci); p = ap.substring(ci + 1); } const lc = hp.lastIndexOf(':'); if (lc > 0) { h = hp.substring(0, lc); pt = Number(hp.substring(lc + 1)); } else { h = hp; pt = 1080; } } else { const lc = s.lastIndexOf(':'); if (lc > 0) { h = s.substring(0, lc); pt = Number(s.substring(lc + 1)); } else { h = s; pt = 1080; } } if (isNaN(pt)) throw new Error(E9); return { username: u, password: p, hostname: h, socksPort: pt }; }
function b64A(b) { if (!b) return { error: null }; try { b = b.replace(/-/g, '+').replace(/_/g, '/'); return { earlyData: Uint8Array.from(atob(b), (c) => c.charCodeAt(0)).buffer, error: null }; } catch (e) { return { error: e }; } }
function isVF(uuid) { return /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(uuid); }
function cSock(s) { try { if (s.readyState === 1 || s.readyState === 2) s.close(); } catch (e) { } }
const hT = Array.from({ length: 256 }, (v, i) => (i + 256).toString(16).slice(1));
function fID(arr, o = 0) { const id = (hT[arr[o]] + hT[arr[o + 1]] + hT[arr[o + 2]] + hT[arr[o + 3]] + "-" + hT[arr[o + 4]] + hT[arr[o + 5]] + "-" + hT[arr[o + 6]] + hT[arr[o + 7]] + "-" + hT[arr[o + 8]] + hT[arr[o + 9]] + "-" + hT[arr[o + 10]] + hT[arr[o + 11]] + hT[arr[o + 12]] + hT[arr[o + 13]] + hT[arr[o + 14]] + hT[arr[o + 15]]).toLowerCase(); if (!isVF(id)) throw new TypeError(E8); return id; }
async function hChk(request) { const url = new URL(request.url), idx = url.searchParams.get('index'), chkOne = async (sc) => { const st = Date.now(); try { const ps = pS5(sc.config), tp = new Promise((_, rej) => setTimeout(() => rej(new Error('è¿æ¥è¶…æ—¶')), 2000)), cp = eSocks(A1, '1.1.1.1', 80, ps), s = await Promise.race([cp, tp]), lt = Date.now() - st; try { s.close(); } catch (e) { } return { region: sc.region, status: 'online', latency: lt }; } catch (e) { return { region: sc.region, status: 'offline', latency: -1, error: e.message || 'Connection failed' }; } }; if (idx !== null) { const i = parseInt(idx); if (i >= 0 && i < SC.length) { const r = await chkOne(SC[i]); return new Response(JSON.stringify(r), { headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } }); } } const rs = []; for (const sc of SC) rs.push(await chkOne(sc)); return new Response(JSON.stringify({ results: rs }), { headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } }); }
function gHTML() { const np = !!(PW && PW.trim()), pv = PW || ''; return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>VLESSè®¢é˜…</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--text:#e6edf3;--muted:#8b949e;--pri:#238636;--prih:#2ea043;--dan:#da3633;--danh:#f85149;--acc:#58a6ff}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:16px;display:flex;align-items:flex-start;justify-content:center}.co{max-width:1056px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:10px}#lo.co{max-width:400px;margin:auto}.h{background:var(--card);color:var(--text);padding:20px;text-align:center;position:relative;border-bottom:1px solid var(--border)}.h h2{font-size:22px;margin-bottom:8px;background:linear-gradient(135deg,#58a6ff,#a371f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.h p{font-size:13px;color:var(--muted)}.h .logout{position:absolute;top:20px;right:20px;color:var(--text);background:transparent;border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px}.h .logout:hover{border-color:var(--acc);color:var(--acc)}.s{padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg)}#ff{padding:16px;display:flex;flex-direction:column;gap:12px}.t{font-size:14px;font-weight:600;margin-bottom:10px;color:var(--text);display:flex;align-items:center;cursor:pointer;user-select:none}.t::before{content:'';display:inline-block;width:4px;height:16px;background:linear-gradient(180deg,#58a6ff,#a371f7);margin-right:8px;border-radius:2px}.t .arrow{margin-left:8px;transition:transform .3s;display:inline-block;color:var(--muted);font-size:12px}.t .arrow.open{transform:rotate(90deg)}.fold-content{max-height:0;overflow:hidden;transition:max-height .3s ease-out}.fold-content.open{max-height:2000px}.btn-group{display:flex;gap:6px;margin-bottom:10px}.btn-small{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);font-size:12px;cursor:pointer}.btn-small:hover{border-color:var(--acc);color:var(--acc)}.btn-small:last-child{margin-left:auto}.dg{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}.di{display:flex;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);font-size:13px;cursor:pointer;overflow:hidden}.di:hover{border-color:var(--acc)}.di.sel{border-color:var(--acc);background:rgba(88,166,255,.1)}.di input{margin-right:8px;cursor:pointer;flex-shrink:0}.di span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--acc)}#sc{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}.c{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;min-width:0}.c.on{border-color:var(--pri);background:rgba(35,134,54,.1)}.c.off{border-color:var(--dan);background:rgba(218,54,51,.1)}.c div{display:flex;justify-content:space-between;gap:4px;margin:3px 0}.c b{font-size:13px;flex-shrink:0;color:var(--text)}.c span{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.c .chk-btn{padding:4px 10px;font-size:11px;background:var(--pri);color:#fff;border:none;border-radius:4px;cursor:pointer;flex-shrink:0}.c .chk-btn:hover{background:var(--prih)}.c .row2{display:flex;align-items:center;justify-content:space-between;gap:4px}.c .left{display:flex;align-items:center;gap:4px;margin:0}.c .ip-row{display:flex;justify-content:space-between;align-items:center;gap:4px}.c .latency{display:inline}.c .m-name{display:none}@media(max-width:767px){#sc{grid-template-columns:repeat(2,1fr)}.c{padding:6px}.c .ip-row{display:none}.c .row2{justify-content:space-between;gap:6px}.c .latency{display:none}.c b{font-size:12px}.c .m-name{display:inline;font-size:12px;font-weight:600;color:var(--text)}}@media(min-width:768px){.dg{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}#sc{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}}.gen{width:100%;padding:12px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer}.gen:hover{background:var(--prih)}.res{margin-top:12px;padding:12px;background:var(--bg);border-radius:6px;border:1px solid var(--border);display:none}.res .app-label{display:inline-block;background:var(--dan);color:#fff;padding:4px 12px;border-radius:4px;font-weight:600;font-size:12px;margin-right:10px;vertical-align:middle;width:70px;text-align:center}.res .link-wrapper{display:flex;align-items:center}.res input{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:11px;background:var(--bg);cursor:pointer;text-align:left;color:var(--acc);font-weight:500}.lo{padding:24px}.lf{display:flex;flex-direction:column;gap:16px}.ig{display:flex;flex-direction:column;gap:6px}.ig label{font-size:13px;font-weight:500;color:var(--muted)}.ig input{padding:10px;border:1px solid var(--border);border-radius:6px;font-size:14px;background:var(--bg);color:var(--text)}.ig input:focus{outline:none;border-color:var(--acc)}.lb{padding:12px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer}.lb:hover{background:var(--prih)}.em{color:var(--dan);font-size:13px;padding:10px;background:rgba(218,54,51,.1);border-radius:6px;display:none}</style></head><body><div class="co" id="lo" style="display:${np ? 'block' : 'none'}"><div class="h"><h2>ğŸ” ç™»å½•</h2></div><div class="lo"><form class="lf" id="lf"><div class="ig"><label>å¯†ç </label><input type="password" id="pw" required></div><div class="em" id="em">å¯†ç é”™è¯¯</div><button type="submit" class="lb">ç™»å½•</button></form></div></div><div class="co" id="mc" style="display:${np ? 'none' : 'block'}"><div class="h"><button class="logout" onclick="logout()">é€€å‡º</button><button class="logout" style="left:20px;right:auto" onclick="goCfg()">é…ç½®</button><h2>ğŸš€ VLESS</h2><p>é€‰æ‹©åŸŸåç”Ÿæˆä¸“å±è®¢é˜…é“¾æ¥(é»˜è®¤443ç«¯å£)ï¼ŒClashè®¢é˜…æ‹¼æ¥ä¸ºè€ç‹å¤§ä½¬çš„åç«¯</p></div><form id="ff"><div class="s"><div class="t" onclick="tgF('dm')">ğŸ”­ ä¼˜é€‰åŸŸå<span class="arrow" id="dm-arrow">â–¶</span></div><div class="fold-content" id="dm-fold"><div class="btn-group"><button type="button" class="btn-small" onclick="sA()">å…¨é€‰</button><button type="button" class="btn-small" onclick="cA()">æ¸…ç©º</button></div><div class="dg" id="dg"></div></div></div><div class="s"><div class="t" onclick="tgF('sk')">ğŸ“¡ SOCKSçŠ¶æ€<span class="arrow" id="sk-arrow">â–¶</span><button type="button" class="btn-small" onclick="event.stopPropagation();chkS()">åˆ·æ–°å…¨éƒ¨</button></div><div class="fold-content" id="sk-fold"><div id="sc">${SC.map((s, i) => `<div class="c" data-i="${i}"><div class="ip-row"><b>${s.region}</b><span id="ip${i}">-</span></div><div class="row2"><div class="left"><span id="s${i}">âšª</span><b class="m-name">${s.region}</b></div><button type="button" class="chk-btn" onclick="event.stopPropagation();chkOne(${i})">æ£€æµ‹</button><span class="latency" id="l${i}">-</span></div></div>`).join('')}</div></div></div><button type="submit" class="gen">âœ¨ ç”Ÿæˆè®¢é˜…</button></form><div id="res" class="res"><div class="link-wrapper"><span class="app-label">V2rayN</span><input type="text" id="url" readonly onclick="cpU()" title="ç‚¹å‡»å¤åˆ¶"></div></div><div id="cres" class="res" style="margin-top:10px"><div class="link-wrapper"><span class="app-label">Clash</span><input type="text" id="curl" readonly onclick="cpC()" title="ç‚¹å‡»å¤åˆ¶"></div></div></div><script>const PW='${pv}',np=${np},ds=[${DD.map(d => `{n:"${d.name || d.domain}",d:"${d.domain}"}`).join(',')}],SC=[${SC.map(s => `{region:"${s.region}",config:"${s.config}"}`).join(',')}];let skChkd=false;function tgF(id){const f=document.getElementById(id+'-fold'),a=document.getElementById(id+'-arrow');const isOpen=f.classList.toggle('open');a.classList.toggle('open',isOpen);if(id==='sk'&&isOpen&&!skChkd){skChkd=true;setTimeout(chkS,300)}}function cl(){return!np||sessionStorage.getItem('vl_l')==='1'}function sm(){document.getElementById('lo').style.display='none';document.getElementById('mc').style.display='block'}const lf=document.getElementById('lf');if(lf){lf.addEventListener('submit',e=>{e.preventDefault();if(document.getElementById('pw').value===PW){sessionStorage.setItem('vl_l','1');sm();init();document.getElementById('em').style.display='none'}else{document.getElementById('em').style.display='block';document.getElementById('pw').value=''}})}function mIP(ip){if(!ip||ip==='-')return ip;if(ip.includes(':')){const p=ip.replace(/^\\[|\\]$/g,'').split(':');if(p.length>=4)return'['+p[0]+':'+p[1]+':***:'+p[p.length-1]+']';return ip}const p=ip.split('.');if(p.length===4)return p[0]+'.***.***.'+p[3];return ip}function pIP(c){try{const a=c.lastIndexOf('@');if(a===-1)return'æœªçŸ¥';const h=c.substring(a+1),ci=h.lastIndexOf(':');const ip=ci===-1?h:h.substring(0,ci);return mIP(ip)}catch(e){return'å¤±è´¥'}}function init(){const g=document.getElementById('dg');g.innerHTML='';ds.forEach(d=>{const di=document.createElement('div');di.className='di';di.innerHTML=\`<input type="checkbox" name="d" value="\${d.d}" onchange="uS(this)"><span>\${d.n}</span>\`;di.onclick=e=>{if(e.target.type!=='checkbox'){const cb=di.querySelector('input');cb.checked=!cb.checked;uS(cb)}};g.appendChild(di)});const cs=document.querySelectorAll('.c');cs.forEach(c=>{const ix=c.dataset.i;const cfg=SC[ix]?.config;if(cfg)document.getElementById('ip'+ix).textContent=pIP(cfg)})}function uS(cb){cb.closest('.di').classList.toggle('sel',cb.checked)}function sA(){document.querySelectorAll('[name="d"]').forEach(cb=>{cb.checked=true;uS(cb)})}function cA(){document.querySelectorAll('[name="d"]').forEach(cb=>{cb.checked=false;uS(cb)})}document.getElementById('ff').onsubmit=function(e){e.preventDefault();const sd=Array.from(document.querySelectorAll('input[name="d"]:checked')).map(cb=>cb.value);const p=new URLSearchParams();if(sd.length>0)p.append('domains',sd.join(','));const u=window.location.origin+'/${T}'+(p.toString()?'?'+p.toString():'');const cu='https://sub.ssss.xx.kg/clash?config='+u+'&ua=&selectedRules="comprehensive"&customRules=[]';document.getElementById('url').value=u;document.getElementById('curl').value=cu;document.getElementById('res').style.display='block';document.getElementById('cres').style.display='block';document.getElementById('url').scrollIntoView({behavior:'smooth',block:'center'})};function cpU(){const i=document.getElementById('url');if(i.value.includes('âœ…'))return;const v=i.value;i.select();document.execCommand('copy');i.value='âœ… å·²å¤åˆ¶æˆåŠŸ!';const oc=i.style.color;i.style.color='#4CAF50';setTimeout(()=>{i.value=v;i.style.color=oc},1500)}function cpC(){const i=document.getElementById('curl');if(i.value.includes('âœ…'))return;const v=i.value;i.select();document.execCommand('copy');i.value='âœ… å·²å¤åˆ¶æˆåŠŸ!';const oc=i.style.color;i.style.color='#4CAF50';setTimeout(()=>{i.value=v;i.style.color=oc},1500)}function logout(){sessionStorage.removeItem('vl_l');location.reload()}function goCfg(){window.location.href='${MNG_URL}/?from=vless'}async function chkOne(ix){const c=document.querySelectorAll('.c')[ix];c.classList.remove('on','off');document.getElementById('s'+ix).textContent='â³';try{const r=await fetch('/api/check-socks?index='+ix),d=await r.json();if(d.status==='online'){document.getElementById('s'+ix).textContent='ğŸŸ¢';document.getElementById('l'+ix).textContent=d.latency+'ms';c.classList.add('on')}else{document.getElementById('s'+ix).textContent='ğŸ”´';document.getElementById('l'+ix).textContent='ç¦»çº¿';c.classList.add('off')}}catch(e){document.getElementById('s'+ix).textContent='ğŸ”´';document.getElementById('l'+ix).textContent='é”™è¯¯';c.classList.add('off')}}async function chkS(){const cs=document.querySelectorAll('.c');cs.forEach(c=>{c.classList.remove('on','off')});for(let i=0;i<cs.length;i++){await chkOne(i)}}window.onload=()=>{if(cl()){sm();init()}else if(np){document.getElementById('lo').style.display='block'}else{init()}}</script></body></html>`; }
